{% extends 'base.html' %}
{% block content %}
<div class="admin-res">
  
  <!-- Header Section -->
  <div class="section-container">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h1 style="margin: 0; font-size: 2rem;">Admin: Reservasjoner</h1>
        <p style="color: var(--muted); margin: 0.5rem 0 0 0;">Administrer og overvÃ¥k alle reservasjoner</p>
      </div>
      <div style="background: var(--bg); padding: 0.75rem 1.25rem; border-radius: var(--radius); border: 1px solid var(--border);">
        <div style="font-size: 0.85rem; color: var(--muted);">Database</div>
        <code style="font-size: 0.9rem; color: var(--accent-2);">{{ db_path }}</code>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid-3" style="margin-bottom: 1.5rem;">
    <div class="section-container" style="text-align: center;">
      <div style="font-size: 3rem; font-weight: 700; color: var(--accent-2); margin-bottom: 0.5rem;">{{ total }}</div>
      <div style="color: var(--muted); font-weight: 600;">Totale reservasjoner</div>
    </div>
    <div class="section-container" style="text-align: center;">
      <div style="font-size: 3rem; font-weight: 700; color: var(--accent-3); margin-bottom: 0.5rem;">{{ total_last_7 }}</div>
      <div style="color: var(--muted); font-weight: 600;">Siste 7 dager</div>
    </div>
    <div class="section-container" style="text-align: center;">
      <div style="font-size: 3rem; font-weight: 700; color: var(--success); margin-bottom: 0.5rem;">{{ reservations|length }}</div>
      <div style="color: var(--muted); font-weight: 600;">Viser nÃ¥</div>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="section-container">
    <h2 style="margin-top: 0; font-size: 1.3rem;">Filtrer reservasjoner</h2>
    <form method="get" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
      <label style="flex: 1; min-width: 200px;">
        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">Velg dato</div>
        <input type="date" id="date" name="date" value="{{ selected_date }}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 1rem;">
      </label>
      <button type="submit" class="btn" style="padding: 0.75rem 2rem;">Filtrer</button>
      {% if selected_date %}
      <a href="{% url 'admin_reservations' %}" class="btn-secondary btn" style="padding: 0.75rem 1.5rem;">Nullstill filter</a>
      {% endif %}
    </form>
  </div>

  <!-- Counts by Date -->
  <div class="section-container">
    <h2 style="margin-top: 0; font-size: 1.3rem;">Antall per dato</h2>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--bg); border-bottom: 2px solid var(--border);">
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--accent);">Dato</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--accent);">Antall reservasjoner</th>
          </tr>
        </thead>
        <tbody>
          {% for item in counts_by_date %}
          <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s ease;" 
              onmouseover="this.style.background='var(--bg)'" 
              onmouseout="this.style.background='transparent'">
            <td style="padding: 0.875rem 1rem; font-weight: 500;">{{ item.dato }}</td>
            <td style="padding: 0.875rem 1rem;">
              <span style="background: var(--accent-2); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.9rem;">
                {{ item.count }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="2" style="padding: 2rem; text-align: center; color: var(--muted);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“…</div>
              Ingen data tilgjengelig.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Schedule Grid -->
  {% if schedule_items %}
  <div class="section-container">
    <h2 style="margin-top: 0; font-size: 1.3rem;">Rutegraf for {{ selected_date }}</h2>
    <div class="grid-schedule">
      {% for s in schedule_items %}
        <div class="slot" style="border: 2px solid var(--border); border-radius: var(--radius); overflow: hidden;">
          <div class="slot-head" style="padding: 0.75rem; background: linear-gradient(135deg, var(--accent-2), var(--accent-3)); color: white; font-weight: 700; text-align: center;">{{ s.ts }}</div>
          <div class="slot-body" style="padding: 0.75rem; background: var(--surface); display: flex; flex-direction: column; gap: 0.5rem; min-height: 60px;">
            {% for r in s.items %}
              <div class="pill" style="display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.5rem 0.75rem;">
                <span class="pill-name" style="font-weight: 600; color: var(--accent);">{{ r.navn }}</span>
                <span class="pill-meta" style="color: var(--muted); font-size: 0.85rem;">bord {{ r.bord_id }} â€¢ {{ r.antall_personer }}p</span>
              </div>
            {% empty %}
              <div class="pill pill-empty" style="text-align: center; color: var(--muted); font-style: italic; padding: 1rem;">Ingen reservasjoner</div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Main Reservations Table -->
  <div class="section-container">
    <h2 style="margin-top: 0; font-size: 1.3rem;">Alle reservasjoner {% if selected_date %}for {{ selected_date }}{% endif %}</h2>
    <div style="overflow-x: auto; margin-top: 1rem;">
      <table style="width: 100%; border-collapse: collapse; background: var(--surface);">
        <thead>
          <tr style="background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white;">
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Navn</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Telefon</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Eâ€‘post</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Dato</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Tid</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; white-space: nowrap;">Gjester</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; white-space: nowrap;">Bord</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; white-space: nowrap;">Kommentar</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; white-space: nowrap;">Handlinger</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reservations %}
          <tr style="border-bottom: 1px solid var(--border); transition: all 0.2s ease;" 
              onmouseover="this.style.background='var(--bg)'; this.style.transform='scale(1.01)'" 
              onmouseout="this.style.background='transparent'; this.style.transform='scale(1)'">
            <td style="padding: 1rem; font-weight: 600; color: var(--accent);">{{ r.navn }}</td>
            <td style="padding: 1rem;">
              <a href="tel:{{ r.telefon }}" style="color: var(--accent-2); text-decoration: none; font-weight: 500;">{{ r.telefon }}</a>
            </td>
            <td style="padding: 1rem;">
              {% if r.epost %}
                <a href="mailto:{{ r.epost }}" style="color: var(--accent-2); text-decoration: none;">{{ r.epost }}</a>
              {% else %}
                <span style="color: var(--muted);">â€“</span>
              {% endif %}
            </td>
            <td style="padding: 1rem; white-space: nowrap;">{{ r.dato }}</td>
            <td style="padding: 1rem; font-weight: 600;">{{ r.tidspunkt }}</td>
            <td style="padding: 1rem; text-align: center;">
              <span style="background: var(--accent-3); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.85rem;">
                {{ r.antall_personer }}
              </span>
            </td>
            <td style="padding: 1rem; text-align: center;">
              <span style="background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-weight: 600;">
                {{ r.bord_id }}
              </span>
            </td>
            <td style="padding: 1rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ r.kommentar|default:'' }}">
              <span style="color: var(--muted);">{{ r.kommentar|default:'â€“' }}</span>
            </td>
            <td style="padding: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch;">
                <form method="post" action="{% url 'delete_reservation' r.id %}" onsubmit="return confirm('Er du sikker pÃ¥ at du vil slette denne reservasjonen?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-danger btn" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">Slett</button>
                </form>
                <form method="post" action="{% url 'send_reservation_email' r.id %}">
                  {% csrf_token %}
                  {% if r.epost %}
                    <input type="hidden" name="to_email" value="{{ r.epost }}">
                    <button type="submit" class="btn-secondary btn" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">Send eâ€‘post</button>
                  {% else %}
                    <input type="email" name="to_email" placeholder="Kundens eâ€‘post" required style="width: 100%; padding: 0.5rem; border: 2px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 0.25rem; font-size: 0.9rem;">
                    <button type="submit" class="btn-secondary btn" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">Send eâ€‘post</button>
                  {% endif %}
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" style="padding: 3rem; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“‹</div>
              <div style="font-size: 1.2rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem;">Ingen reservasjoner funnet</div>
              <div style="color: var(--muted);">PrÃ¸v Ã¥ justere filteret eller vent pÃ¥ nye bestillinger.</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<style>
.admin-res { max-width: 1400px; margin: 0 auto; }
.grid-schedule { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
  gap: 1rem; 
  margin-top: 1rem; 
}
</style>
{% endblock %}